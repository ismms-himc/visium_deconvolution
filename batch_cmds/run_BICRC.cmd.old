/sc/arion/projects/HIMC/himc-project-data/MIME22/data/10X/MIME22_BIC18-A5_0_v2/
/sc/arion/projects/HIMC/himc-project-data/MIME22/data/10X/MIME22_BIC18-A7_0_v2/
/sc/arion/projects/HIMC/himc-project-data/MIME22/data/10X/MIME22_BIC21-A5_0_v2/
/sc/arion/projects/HIMC/himc-project-data/MIME22/data/10X/MIME22_BIC21-A6_0_v2/
/sc/arion/projects/HIMC/himc-project-data/MIME22/data/10X/MIME22_BIC31-B4_0_v3/
/sc/arion/projects/HIMC/himc-project-data/MIME22/data/10X/MIME22_BIC31B6-V2_0_v2/

/sc/arion/projects/HIMC/himc-project-data/SEKI10/data/10X/SEKI10_BIC13_1_v3

# Get avg number of cells/spot
head -n6 run_BICRC.cmd | parallel -j1 -k "tail -n+2 {}/qupath_processing/stardist_detections_per_barcode.csv | cut -d, -f2 | grep -v 0 | awk '{sum += \$0} END {print sum/NR}'"

head -n6 run_BICRC.cmd | parallel -j1 -k "echo {}; ls -l {}/deconvolution/CRC_curated_Vladimir/"

##############################################################################
# Vladimir CRC reference
##############################################################################

(cat << EOF
MIME22_BIC18-A5_0_v2
MIME22_BIC18-A7_0_v2
MIME22_BIC21-A5_0_v2
MIME22_BIC21-A6_0_v2
MIME22_BIC31-B4_0_v3
MIME22_BIC31B6-V2_0_v2
EOF
) |  parallel --dryrun -j1 -k \
"
cat << EOF > tmp/{}.sh
nextflow run main.nf \
--rna_h5ad /sc/arion/projects/HIMC/reference/single_cell_references/CRC_Merad_lab/crc_v8_complete.h5ad \
--rna_h5Seurat /sc/arion/projects/HIMC/reference/single_cell_references/CRC_Merad_lab/crc_v8_complete.rds \
--spatial_h5ad /sc/arion/projects/HIMC/himc-project-data/MIME22/data/10X/{} \
--celltype_key selection_annotation \
--c2l_batch SAMPLE \
--c2l_covariates PROTOCOL \
--c2l_cellsPerSpot 27 \
--outdir_final /sc/arion/projects/HIMC/himc-project-data/MIME22/data/10X/{}/deconvolution/CRC_curated_Vladimir/ \
-w work/{}
EOF
bsub_premium {} 'sh tmp/{}.sh'
"



# Tabula Sapiens dataset
(cat << EOF
MIME22_BIC18-A5_0_v2
MIME22_BIC18-A7_0_v2
MIME22_BIC21-A5_0_v2
MIME22_BIC21-A6_0_v2
MIME22_BIC31-B4_0_v3
MIME22_BIC31B6-V2_0_v2
EOF
) |  parallel --dryrun -j1 -k \
"
bsub_premium \
{} \
'nextflow run main.nf \
--rna_h5ad /sc/arion/projects/HIMC/reference/single_cell_references/TabulaMurisSapiens/Large_Intestine/TS_Large_Intestine.h5ad \\
--rna_h5Seurat /sc/arion/projects/HIMC/reference/single_cell_references/TabulaMurisSapiens/Large_Intestine/TS_Large_Intestine.h5seurat \\
--spatial_h5ad /sc/arion/projects/HIMC/himc-project-data/MIME22/data/10X/{} \\
--celltype_key free_annotation \\
--c2l_batch None \\
--c2l_covariates None \\
--c2l_cellsPerSpot 30 \\
--outdir_final /sc/arion/projects/HIMC/himc-project-data/MIME22/data/10X/{}/deconvolution/TabulaMurisSapiens_LargeIntestine/'
"

# CRC Immune hubs
(cat << EOF
MIME22_BIC18-A5_0_v2
MIME22_BIC18-A7_0_v2
MIME22_BIC21-A5_0_v2
MIME22_BIC21-A6_0_v2
MIME22_BIC31-B4_0_v3
MIME22_BIC31B6-V2_0_v2
EOF
) |  parallel --dryrun -j1 -k \
"
bsub_premium \
{} \
'nextflow run main.nf \
--rna_h5ad /sc/arion/projects/HIMC/reference/single_cell_references/CRC_immune_hubs/CRC_immune_hubs_downsampled.h5ad \\
--rna_h5Seurat /sc/arion/projects/HIMC/reference/single_cell_references/CRC_immune_hubs/CRC_immune_hubs_downsampled.h5seurat \\
--spatial_h5ad /sc/arion/projects/HIMC/himc-project-data/MIME22/data/10X/{} \\
--celltype_key ClusterFull \\
--c2l_batch None \\
--c2l_covariates None \\
--c2l_cellsPerSpot 30 \\
--outdir_final /sc/arion/projects/HIMC/himc-project-data/MIME22/data/10X/{}/deconvolution/CRC_immune_hubs_downsampled/'
"

# CRC Immune hubs c2l only
(cat << EOF
MIME22_BIC18-A5_0_v2
MIME22_BIC18-A7_0_v2
MIME22_BIC21-A5_0_v2
MIME22_BIC21-A6_0_v2
MIME22_BIC31-B4_0_v3
MIME22_BIC31B6-V2_0_v2
EOF
) |  parallel --dryrun -j1 -k \
"
bsub_premium \
{} \
'nextflow run main.nf \
--rna_h5ad /sc/arion/projects/HIMC/reference/single_cell_references/CRC_immune_hubs/CRC_immune_hubs_downsampled.h5ad \\
--rna_h5Seurat /sc/arion/projects/HIMC/reference/single_cell_references/CRC_immune_hubs/CRC_immune_hubs_downsampled.h5seurat \\
--spatial_h5ad /sc/arion/projects/HIMC/himc-project-data/MIME22/data/10X/{} \\
--celltype_key ClusterFull \\
--c2l_batch None \\
--c2l_covariates None \\
--c2l_cellsPerSpot 30 \\
--outdir_final /sc/arion/projects/HIMC/himc-project-data/MIME22/data/10X/{}/deconvolution/CRC_immune_hubs_downsampled/ \\
--tools cell2location
'
"

### debug

bsub_premium \
MIME22_BIC31B6-V2_0_v2_c2l \
"
nextflow run main.nf \
--rna_h5ad /sc/arion/projects/HIMC/reference/single_cell_references/CRC_immune_hubs/CRC_immune_hubs_downsampled.h5ad \
--rna_h5Seurat /sc/arion/projects/HIMC/reference/single_cell_references/CRC_immune_hubs/CRC_immune_hubs_downsampled.h5seurat \
--spatial_h5ad /sc/arion/projects/HIMC/himc-project-data/MIME22/data/10X/MIME22_BIC31B6-V2_0_v2 \
--celltype_key ClusterFull \
--c2l_batch None \
--c2l_covariates None \
--c2l_cellsPerSpot 30 \
--outdir_final /sc/arion/projects/HIMC/himc-project-data/MIME22/data/10X/MIME22_BIC31B6-V2_0_v2/deconvolution/CRC_immune_hubs_downsampled/ \
--tools cell2location
"

function bsub_gpu_test { 
 bsub -L /bin/bash -W 144:00 -P acc_HIMC -n 32 -q gpu -R v100 -R rusage[ngpus_excl_p=4] -o ${BSUB_LOGS}/${1}_%J.stdout -eo ${BSUB_LOGS}/${1}_%J.stderr -J $1 $2
}

bsub_gpu_test \
MIME22_BIC31B6-V2_0_v2_c2l \
"
nextflow run main.nf \
--rna_h5ad /sc/arion/projects/HIMC/reference/single_cell_references/CRC_immune_hubs/CRC_immune_hubs_downsampled.h5ad \
--rna_h5Seurat /sc/arion/projects/HIMC/reference/single_cell_references/CRC_immune_hubs/CRC_immune_hubs_downsampled.h5seurat \
--spatial_h5ad /sc/arion/projects/HIMC/himc-project-data/MIME22/data/10X/MIME22_BIC31B6-V2_0_v2 \
--celltype_key ClusterFull \
--c2l_batch None \
--c2l_covariates None \
--c2l_cellsPerSpot 30 \
--outdir_final /sc/arion/projects/HIMC/himc-project-data/MIME22/data/10X/MIME22_BIC31B6-V2_0_v2/deconvolution/CRC_immune_hubs_downsampled/ \
--tools cell2location
"
##########################

/sc/arion/projects/HIMC/himc-project-data/SEKI10/data/10X/SEKI10_BIC13_1_v2


